# Agent Quick Reference

**é’ˆå¯¹ AI Agent çš„ opencode-go-mcp ä½¿ç”¨æŒ‡å—**

å½“ä½ ï¼ˆAIï¼‰è¿æ¥åˆ°æ­¤ MCP æœåŠ¡å™¨æ—¶ï¼Œä»¥ä¸‹å·¥å…·å¯ä¾›ä½¿ç”¨ã€‚æ‰€æœ‰å·¥å…·é€šè¿‡ JSON-RPC stdio é€šä¿¡ï¼Œæ— éœ€é¢å¤–é…ç½®ã€‚

---

## ğŸ¯ æ ¸å¿ƒå·¥ä½œæµå»ºè®®

### å…¸å‹ç¼–ç å¾ªç¯

1. **æ¢ç´¢é¡¹ç›®**: ä½¿ç”¨ `list_directory` äº†è§£ç»“æ„ï¼Œå†ç”¨ `search_symbols` æˆ– `search_code` å®šä½ç›¸å…³æ–‡ä»¶
2. **è¯»å–ä¸Šä¸‹æ–‡**: ä½¿ç”¨ `read_file` è¯»å–ç›®æ ‡æ–‡ä»¶ï¼Œæˆ–ç”¨ `get_file_context` è‡ªåŠ¨èšåˆä¾èµ–
3. **æå‡ºä¿®æ”¹**: åŸºäºæ–‡ä»¶å†…å®¹ç”Ÿæˆè¡¥ä¸ï¼Œå…ˆç”¨ `apply_patch` with `dry_run: true` é¢„è§ˆ
4. **åº”ç”¨è¡¥ä¸**: ç¡®è®¤é¢„è§ˆæ— è¯¯åï¼Œ`dry_run: false` åº”ç”¨
5. **éªŒè¯**: ä½¿ç”¨ `run_build` æ‰§è¡Œ `go test` æˆ– `go build` éªŒè¯
6. **é‡å¤**: æ ¹æ®é”™è¯¯è°ƒæ•´

### æœç´¢ç­–ç•¥

- **å·²çŸ¥æ–‡ä»¶** â†’ `read_file` ç›´æ¥è¯»å–
- **ç¬¦å·åç§°**ï¼ˆå‡½æ•°/ç»“æ„ä½“ï¼‰â†’ `search_symbols`ï¼ˆæ›´ç²¾ç¡®ï¼‰
- **å…³é”®è¯** â†’ `search_code`ï¼ˆæ›´å¿«ï¼Œä½†å¯èƒ½å™ªå£°å¤šï¼‰
- **ä¸äº†è§£é¡¹ç›®ç»“æ„** â†’ `list_directory` é€’å½’æµè§ˆ 1-2 å±‚

---

## ğŸ› ï¸ å·¥å…·é€ŸæŸ¥è¡¨

| å·¥å…·å | å‚æ•°è¦ç‚¹ | è¿”å›å€¼å…³é”®å­—æ®µ | å…¸å‹ä½¿ç”¨åœºæ™¯ |
|--------|----------|----------------|--------------|
| `opencode.read_file` | `path` (req), `max_bytes` (opt, def 1MB) | `content[0].text`, `truncated` | æŸ¥çœ‹æ–‡ä»¶å†…å®¹ |
| `opencode.write_file` | `path` (req), `content` (req), `allow_create` (def true), `message` (opt) | `success` | åˆ›å»º/æ›´æ–°æ–‡ä»¶ |
| `opencode.list_directory` | `path` (req), `depth` (def 1), `exclude` (opt) | `files[]` with `is_dir`, `size` | åˆ—å‡ºç›®å½•å†…å®¹ |
| `opencode.search_code` | `query` (req), `path` (opt), `limit` (def 50) | `results[]` with `line`, `preview` | å…¨æ–‡æœç´¢ |
| `opencode.search_symbols` | `query` (req), `limit` (def 50) | `symbols[]` with `type`, `file_path`, `line` | æŸ¥æ‰¾å‡½æ•°/ç»“æ„ä½“å®šä¹‰ |
| `opencode.get_file_context` | `path` (req), `max_depth` (def 2) | `content[]` å¤šä¸ªæ–‡ä»¶ | ç†è§£ä¾èµ–å…³ç³» |
| `opencode.apply_patch` | `path` (req), `patch` (req), `dry_run` (def false) | `success`, `dry_run`, `preview` (if dry-run) | åº”ç”¨è¡¥ä¸ |
| `opencode.run_build` | `command` (req), `args` (req) | `success`, `output`, `errors[]`, `duration_ms` | æ„å»º/æµ‹è¯• |
| `opencode.health` | (none) | `status`, `version`, `tools[]`, `stats` | æ£€æŸ¥æœåŠ¡çŠ¶æ€ |

---

## ğŸ“ å·¥å…·å“åº”æ ¼å¼ï¼ˆMCP ToolResponseï¼‰

æ‰€æœ‰å·¥å…·è¿”å›ç»“æ„åŒ–çš„ JSONï¼ŒåŒ…å«ï¼š

```json
{
  "content": [
    {
      "type": "text",
      "text": "JSON string of the tool's result"
    }
  ],
  "isError": false
}
```

å®é™… payload åœ¨ `content[0].text` ä¸­ï¼Œæ˜¯ä¸€ä¸ª JSON å­—ç¬¦ä¸²ï¼Œéœ€è¦è§£æã€‚

### ç¤ºä¾‹ï¼šread_file è¿”å›

```json
{
  "content": [
    {
      "text": "{\"content\":[{\"text\":\"package main\\n\\nfunc main(){\\n}\\n\"}],\"truncated\":false}"
    }
  ],
  "isError": false
}
```

è¦æå–æ–‡ä»¶å†…å®¹ï¼š

1. å– `content[0].text`
2. `json.Unmarshal` å¾—åˆ° `{"content":[{"text":"..."}],"truncated":false}`
3. å†å– `content[0].text` å¾—åˆ°å®é™…æ–‡ä»¶å†…å®¹

---

## âš ï¸ å¸¸è§é™·é˜±

### 1. è·¯å¾„é—®é¢˜

- `path` æ˜¯ç›¸å¯¹äºé¡¹ç›®æ ¹ç›®å½•çš„è·¯å¾„ï¼Œä¸æ˜¯ç»å¯¹è·¯å¾„
- å¦‚æœé…ç½®äº† `allowed_paths`ï¼Œè·¯å¾„å¿…é¡»åœ¨ç™½åå•å†…
- ä½¿ç”¨ `list_directory` å…ˆç¡®è®¤æ–‡ä»¶å­˜åœ¨

### 2. å¤§å°é™åˆ¶

- `read_file` é»˜è®¤æœ€å¤š 1MBï¼Œ`max_bytes` å¯è°ƒæ•´ï¼ˆä½åŠŸè€—æ¨¡å¼å¼ºåˆ¶é™åˆ¶ä¸º 64KBï¼‰
- `write_file` å•æ¬¡æœ€å¤š 128KBï¼ˆä½åŠŸè€—æ¨¡å¼ï¼‰
- å¤§æ–‡ä»¶è€ƒè™‘ç”¨ `get_file_context` åªè¯»å–å…³é”®éƒ¨åˆ†

### 3. è¡¥ä¸æ ¼å¼

`apply_patch` éœ€è¦ standard unified diffï¼š

```
--- a/file.go
+++ b/file.go
@@ -1,3 +1,4 @@
+// new line
 package main
```

å¯ç”¨ `diff -u` æˆ–åœ¨çº¿ diff ç”Ÿæˆå™¨ã€‚

** Always dry-run first **ï¼šå…ˆè®¾ç½® `dry_run: true` å®¡æŸ¥é¢„è§ˆï¼Œç¡®è®¤å†åº”ç”¨ã€‚

### 4. æ„å»ºè¶…æ—¶

`run_build` é»˜è®¤ 60 ç§’è¶…æ—¶ã€‚å¤§é¡¹ç›®æµ‹è¯•å¯èƒ½è¶…æ—¶ã€‚é”™è¯¯ä¿¡æ¯ï¼š

```json
{
  "errors": [
    {
      "file": "",
      "line": 0,
      "message": "build timeout"
    }
  ]
}
```

è§£å†³æ–¹æ¡ˆï¼šä¿®æ”¹é…ç½®æ–‡ä»¶å¢åŠ  `build_timeout`ã€‚

---

## ğŸ”’ å®‰å…¨ç†è§£

ä½œä¸º AIï¼Œä½ **ä¸èƒ½**ï¼š

- è®¿é—® `allowed_paths` å¤–çš„æ–‡ä»¶ï¼ˆä¼šè¿”å› permission_deniedï¼‰
- è¯»å–æ•æ„Ÿæ‰©å±•åï¼ˆ`.env`, `.key`, `.pem` ç­‰ï¼Œä¼šè¢«æ‹¦æˆªï¼‰
- æ‰§è¡Œéç™½åå•å‘½ä»¤ï¼ˆ`run_build` ä»…å…è®¸ `go` ç›¸å…³å‘½ä»¤ï¼‰

å¦‚æœç”¨æˆ·éœ€è¦è®¿é—®ç‰¹å®šè·¯å¾„ï¼Œè®©ä»–ä»¬ä¿®æ”¹é…ç½®ã€‚ä¸è¦å°è¯•è·¯å¾„éå†æ”»å‡»ï¼ˆå¦‚ `../../../etc/passwd`ï¼‰â€”â€”ä¼šè¢« `checkSecurity` æ‹¦æˆªã€‚

---

## ğŸ” è°ƒè¯•æç¤º

### æŸ¥çœ‹æœåŠ¡çŠ¶æ€

```json
{
  "tool": "opencode.health",
  "params": {}
}
```

å…³æ³¨ `stats.cache_hit_ratio`ï¼šè¿‡ä½è¯´æ˜é¢‘ç¹è¯»å–æ–°æ–‡ä»¶ï¼Œå¯è€ƒè™‘ç¼“å­˜ç­–ç•¥ã€‚

### æµ‹è¯• MCP è¿æ¥

```bash
# æ‰‹åŠ¨å‘é€ initialize è¯·æ±‚
echo '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"test"}}}' | ./opencode-mcp
```

åº”è¿”å› `initialize` å“åº”å’Œ `tools/list` é€šçŸ¥ã€‚

---

## ğŸ¯ æœ€ä½³å®è·µ

1. **å…ˆæœç´¢ï¼Œå†è¯»å–**ï¼šç”¨ `search_symbols` å¿«é€Ÿå®šä½ï¼Œé¿å… `list_directory` å…¨ç›®å½•æ‰«æ
2. **ä½¿ç”¨ç¼“å­˜**ï¼šå¯¹åŒä¸€ä¸ªæ–‡ä»¶å¤šæ¬¡è¯»å–ï¼Œ`read_file` æœ‰ç¼“å­˜ï¼Œæ€§èƒ½å¾ˆå¥½
3. **å¢é‡ä¿®æ”¹**ï¼šæ¯æ¬¡åªåº”ç”¨ä¸€ä¸ªå°è¡¥ä¸ï¼Œç„¶å `run_build` éªŒè¯ï¼Œä¸è¦ä¸€æ¬¡æ”¹å¤ªå¤š
4. **ä¸Šä¸‹æ–‡èšåˆ**ï¼šä¿®æ”¹æ¥å£æ—¶ï¼Œç”¨ `get_file_context` è¯»å–æ‰€æœ‰å®ç°æ–‡ä»¶
5. **é”™è¯¯å¤„ç†**ï¼š`run_build` è¿”å›çš„ `errors` æ•°ç»„æŒ‰é¡ºåºæ’åˆ—ï¼Œä¿®å¤ç¬¬ä¸€æ¡å†ç»§ç»­
6. **dry-run ä¹ æƒ¯**ï¼šä»»ä½• `apply_patch` å‰å…ˆé¢„è§ˆï¼Œé¿å…è¯¯ä¿®æ”¹

---

## ğŸŒ± æ ‘è“æ´¾ç¯å¢ƒéƒ¨ç½²ä¸ä½¿ç”¨è¯´æ˜

æœ¬ MCP ç‰¹åˆ«è€ƒè™‘åœ¨ä½åŠŸè€—è®¾å¤‡ï¼ˆå¦‚æ ‘è“æ´¾ Zero 2Wï¼‰ä¸Šè¿è¡Œã€‚

### å¯¹ç”¨æˆ·ï¼ˆäººç±»ï¼‰çš„ç®€è¦éƒ¨ç½²æ­¥éª¤

åœ¨æ ‘è“æ´¾ä¸Šï¼š

1. å®‰è£…ä¾èµ–
   - `sudo apt update`
   - å®‰è£… Git ä¸æ„å»ºå·¥å…·ï¼š`sudo apt install -y git build-essential`
   - å®‰è£… Goï¼ˆ1.22+ï¼‰ï¼Œå¹¶ç¡®ä¿ `go version` æ­£å¸¸ã€‚
2. è·å–ä»£ç å¹¶ç¼–è¯‘
   - `git clone https://github.com/<your-org>/opencode-go-mcp.git`
   - `cd opencode-go-mcp`
   - `go build -o opencode-mcp ./cmd/opencode-mcp`
3. é…ç½® OpenCode å‡­è¯
   - è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œä¾‹å¦‚ï¼š
     - `export OPCODE_TOKEN="ä½ çš„-opencode-token"`
     - å¯é€‰ï¼š`OPCODE_DEFAULT_PROJECT`, `OPCODE_LOG_LEVEL=info` ç­‰ã€‚
4. åœ¨ MCP å®¿ä¸»ï¼ˆä¾‹å¦‚è¿è¡Œåœ¨æ ‘è“æ´¾ä¸Šçš„ AI å®¢æˆ·ç«¯ï¼‰ä¸­é…ç½®ï¼š
   - `command`: `/home/pi/opencode-go-mcp/opencode-mcp`
   - `env`: åŒ…å« `OPCODE_TOKEN` ç­‰ç¯å¢ƒå˜é‡ã€‚

ä¹‹åï¼Œç”± MCP å®¿ä¸»è´Ÿè´£é€šè¿‡ stdio å¯åŠ¨è¯¥è¿›ç¨‹ã€‚

### å¯¹ä½ ï¼ˆAI Agentï¼‰çš„æ ‘è“æ´¾ä½¿ç”¨å»ºè®®

æ ‘è“æ´¾èµ„æºæœ‰é™ï¼Œè¯·ç‰¹åˆ«æ³¨æ„ï¼š

- æ§åˆ¶å¹¶å‘
  - åŒæ—¶å‘èµ·çš„ MCP è¯·æ±‚å»ºè®®æ§åˆ¶åœ¨ 2â€“4 ä¸ªä»¥å†…ã€‚
  - é¿å…åœ¨çŸ­æ—¶é—´å†…å‘èµ·å¤§é‡ `search_code` æˆ– `run_build` è¯·æ±‚ã€‚
- æ§åˆ¶è¯»å–é‡
  - ä½¿ç”¨ `max_bytes` é™åˆ¶ `read_file` è¿”å›çš„å¤§å°ï¼ˆå¦‚ 64KB æˆ– 128KBï¼‰ã€‚
  - å¯¹å¤§æ–‡ä»¶ä¼˜å…ˆä½¿ç”¨ `get_file_context` è¯»å–å…³é”®éƒ¨åˆ†ï¼Œè€Œä¸æ˜¯æ•´æ–‡ä»¶ã€‚
- è°¨æ…æ„å»ºä¸æµ‹è¯•
  - ä½¿ç”¨ `run_build` æ—¶ï¼Œä¼˜å…ˆæ‰§è¡Œå¢é‡ã€å°èŒƒå›´çš„å‘½ä»¤ï¼ˆä¾‹å¦‚å•åŒ…æµ‹è¯•ï¼‰ï¼Œé¿å…é¢‘ç¹å…¨ä»“åº“æ„å»ºã€‚
  - è‹¥é‡åˆ°è¶…æ—¶æˆ–èµ„æºä¸è¶³é”™è¯¯ï¼Œä¼˜å…ˆç¼©å°æµ‹è¯•èŒƒå›´ï¼Œè€Œä¸æ˜¯é‡è¯•åŒæ ·çš„é‡å‘½ä»¤ã€‚
- åˆç†åˆ†æ‰¹ä¿®æ”¹
  - å°†æ”¹åŠ¨æ‹†æˆå¤šæ¬¡å°è¡¥ä¸ï¼Œé€æ¬¡ `apply_patch` + `run_build`ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§å¤§é‡æ„ã€‚

åœ¨æ ‘è“æ´¾ç¯å¢ƒä¸­ï¼Œä½ çš„ç›®æ ‡æ˜¯ï¼š**æœ€å°åŒ–å•æ¬¡ I/O å’Œ CPU å ç”¨ï¼ŒåŒæ—¶ä¿æŒä¿®æ”¹çš„å¯éªŒè¯æ€§ã€‚**

---

## ğŸ“š ç¤ºä¾‹å¯¹è¯

**ç”¨æˆ·**: "å¸®æˆ‘ç»™ main.go æ·»åŠ ä¸€ä¸ª Println è°ƒç”¨"

**AI æ€è€ƒæµç¨‹**:

1. `read_file("main.go")` â†’ è·å–å½“å‰å†…å®¹
2. ç”Ÿæˆè¡¥ä¸ï¼ˆä¾‹å¦‚åœ¨å‡½æ•°å†…æ’å…¥ `println("hello")`ï¼‰
3. `apply_patch(path="main.go", patch=..., dry_run=true)` â†’ é¢„è§ˆ
4. AI å‘ç”¨æˆ·å±•ç¤ºé¢„è§ˆï¼š"æˆ‘æ‰“ç®—åœ¨è¿™äº›è¡Œæ·»åŠ ... æ˜¯å¦åŒæ„ï¼Ÿ"
5. ç”¨æˆ·åŒæ„å: `apply_patch(..., dry_run=false)`
6. `run_build(command="go", args=["build"])` â†’ éªŒè¯
7. å¦‚æœæˆåŠŸï¼Œå›å¤ç”¨æˆ·ï¼›å¦‚æœå¤±è´¥ï¼Œæ ¹æ®é”™è¯¯è°ƒæ•´

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- **ç”¨æˆ·è§†è§’**: [README.md](README.md) - å®‰è£…ã€é…ç½®ã€Claude Desktop é›†æˆ
- **é…ç½®è¯¦è§£**: [CONFIGURATION.md](CONFIGURATION.md) - æ‰€æœ‰é…ç½®é€‰é¡¹
- **å·¥å…·æ‰‹å†Œ**: [TOOLS.md](TOOLS.md) - æ¯ä¸ªå·¥å…·çš„è¯¦ç»†å‚æ•°å’Œç¤ºä¾‹
- **å¼€å‘è€…**: [DEVELOPMENT.md](DEVELOPMENT.md) - å¦‚ä½•æ„å»ºã€æµ‹è¯•ã€è´¡çŒ®

---

**ä½ ï¼ˆAIï¼‰ä¸éœ€è¦å…³å¿ƒé…ç½®å’Œå®‰è£…â€”â€”é‚£æ˜¯ç”¨æˆ·çš„äº‹ã€‚ä½ åªéœ€è¦çŸ¥é“è¿™äº›å·¥å…·å¯ç”¨ï¼Œå¹¶æŒ‰ç…§ä¸Šè¿°æŒ‡å—è°ƒç”¨å³å¯ã€‚**

ç¥ä½ ç¼–ç æ„‰å¿«ï¼ğŸ¤–âœ¨
